<article class="viz-article">
	<div class="viz-container">
		<section class="viz-content-block viz-content-map">
			<header class="viz-generator-header">
				<h4 class="viz-hed viz-map-hed viz-terms">Most Distinctive Food by State</h4>
				<h4 class="viz-hed viz-map-hed viz-ranch">Relative Popularity: Ranch Dressing</h4>
				<h4 class="viz-hed viz-map-hed viz-chile">Relative Popularity: Green Chile</h4>
				<h4 class="viz-hed viz-map-hed viz-bell">Relative Popularity: Green Bell Pepper</h4>
				<h4 class="viz-hed viz-map-hed viz-cheesesteak">Relative Popularity: Cheesesteak</h4>
				<h4 class="viz-hed viz-map-hed viz-pecan">Relative Popularity: Pecan</h4>
				<div class="viz-btns-wrapper">
					<a class="viz-nav-btn viz-smallcaps viz-terms-btn viz-nav-btn-active">All</a>
					<a class="viz-nav-btn viz-smallcaps viz-regional-btn" data-term="chile">Green Chile</a>
					<a class="viz-nav-btn viz-smallcaps viz-regional-btn" data-term="cheesesteak">Cheesesteak</a>
					<a class="viz-nav-btn viz-smallcaps viz-regional-btn" data-term="bell">Green Bell Pepper</a>
					<a class="viz-nav-btn viz-smallcaps viz-regional-btn" data-term="ranch">Ranch Dressing</a>
					<a class="viz-nav-btn viz-smallcaps viz-regional-btn" data-term="pecan">Pecan</a>
				</div>
			</header>
			<div class="viz-svg-wrap">
				<img class="viz-map-overlay" src="http://www.guswezerek.com/projects/food_genius/img/popular_ingredients.png" />
			</div>
			<div class="viz-proxy viz-proxy-HI" id="HI"></div>
			<div class="viz-proxy viz-proxy-FL" id="FL"></div>
			<div class="viz-proxy viz-proxy-VT" id="VT"></div>
			<div class="viz-proxy viz-proxy-NH" id="NH"></div>
			<div class="viz-proxy viz-proxy-MA" id="MA"></div>
			<div class="viz-proxy viz-proxy-RI" id="RI"></div>
			<div class="viz-proxy viz-proxy-CT" id="CT"></div>
			<div class="viz-proxy viz-proxy-NJ" id="NJ"></div>
			<div class="viz-proxy viz-proxy-DE" id="DE"></div>
			<div class="viz-proxy viz-proxy-MD" id="MD"></div>
			<div class="viz-proxy viz-proxy-DC" id="DC"></div>
			<div class="viz-hover-callout">
				<li class="viz-state" data-state="NY">
					<a class="viz-state-anchor"><h5 class="viz-subhead">New York</h5></a>
					<table class="viz-table">
						<thead class="viz-thead">
							<tr class="viz-body-tr">
								<th class="viz-th" scope="col">Term</th>
								<th class="viz-th viz-table-quant-val viz-table-downplay-val" scope="col">NY (%)</th>
								<th class="viz-th viz-table-quant-val viz-table-downplay-val" scope="col">U.S. (%)</th>
								<th class="viz-th viz-table-quant-val" scope="col">Diff. (%)</th>
							</tr>
						</thead>
						<tbody>
							<tr class="viz-body-tr">
								<td class="viz-td">eggplant</td>
								<td class="viz-td viz-table-quant-val viz-table-downplay-val">54</td>
								<td class="viz-td viz-table-quant-val viz-table-downplay-val">37</td>
								<td class="viz-td viz-table-quant-val">17</td>
							</tr>
						
							<tr class="viz-body-tr">
								<td class="viz-td">cutlet</td>
								<td class="viz-td viz-table-quant-val viz-table-downplay-val">29</td>
								<td class="viz-td viz-table-quant-val viz-table-downplay-val">13</td>
								<td class="viz-td viz-table-quant-val">16</td>
							</tr>
						
							<tr class="viz-body-tr">
								<td class="viz-td">roll</td>
								<td class="viz-td viz-table-quant-val viz-table-downplay-val">50</td>
								<td class="viz-td viz-table-quant-val viz-table-downplay-val">37</td>
								<td class="viz-td viz-table-quant-val">13</td>
							</tr>
						
							<tr class="viz-body-tr">
								<td class="viz-td">parmigiana</td>
								<td class="viz-td viz-table-quant-val viz-table-downplay-val">25</td>
								<td class="viz-td viz-table-quant-val viz-table-downplay-val">14</td>
								<td class="viz-td viz-table-quant-val">12</td>
							</tr>
						
							<tr class="viz-body-tr">
								<td class="viz-td">cold</td>
								<td class="viz-td viz-table-quant-val viz-table-downplay-val">35</td>
								<td class="viz-td viz-table-quant-val viz-table-downplay-val">25</td>
								<td class="viz-td viz-table-quant-val">11</td>
							</tr>
						</tbody>
					</table>
				</li>
			</div>
			<div class="viz-intro-and-legend">
				<p class="viz-copy viz-map-intro viz-terms">The map above shows each state's top ingredient or dish, but Food Genius also tracks sensory terms such as "creamy" and preparation terms like "blended." We've included those words in the Top 5 chart for each state. Touch a state to see its top terms, or explore distinctiveness maps for the five terms above.</p>
				<p class="viz-copy viz-map-intro viz-ranch"><span class="viz-leadin viz-intro-leadin">Ranch Dressing</span> Each state's top ingredient or dish, but Food Genius also tracks sensory terms such as "creamy" and preparation terms like "blended." We've included those words in the Top 5 chart for each state. Touch a state to see its top terms, or explore distinctiveness maps for the five terms above.</p>
				<p class="viz-copy viz-map-intro viz-chile"><span class="viz-leadin viz-intro-leadin">Green Chile</span> Each state's top ingredient or dish, but Food Genius also tracks sensory terms such as "creamy" and preparation terms like "blended." We've included those words in the Top 5 chart for each state. Touch a state to see its top terms, or explore distinctiveness maps for the five terms above.</p>
				<p class="viz-copy viz-map-intro viz-bell"><span class="viz-leadin viz-intro-leadin">Green Bell Pepper</span> Each state's top ingredient or dish, but Food Genius also tracks sensory terms such as "creamy" and preparation terms like "blended." We've included those words in the Top 5 chart for each state. Touch a state to see its top terms, or explore distinctiveness maps for the five terms above.</p>
				<p class="viz-copy viz-map-intro viz-cheesesteak"><span class="viz-leadin viz-intro-leadin">Cheesesteak</span> Each state's top ingredient or dish, but Food Genius also tracks sensory terms such as "creamy" and preparation terms like "blended." We've included those words in the Top 5 chart for each state. Touch a state to see its top terms, or explore distinctiveness maps for the five terms above.</p>
				<p class="viz-copy viz-map-intro viz-pecan"><span class="viz-leadin viz-intro-leadin">Pecan</span> Each state's top ingredient or dish, but Food Genius also tracks sensory terms such as "creamy" and preparation terms like "blended." We've included those words in the Top 5 chart for each state. Touch a state to see its top terms, or explore distinctiveness maps for the five terms above.</p>
				<div class="viz-legend">
					<p class="viz-scale-label viz-smallcaps">Relative Popularity <span class="viz-detail">(Difference between term's frequency on menus in state vs. U.S.)</span></p>
					<ul class="viz-scale viz-scale-ing">
						<li class="viz-scale-segment viz-smallcaps viz-detail viz-ing-segment">10
						<li class="viz-scale-segment viz-smallcaps viz-detail viz-ing-segment"><span class="viz-segment-label">20</span>
						<li class="viz-scale-segment viz-smallcaps viz-detail viz-ing-segment"><span class="viz-segment-label">30</span>
						<li class="viz-scale-segment viz-smallcaps viz-detail viz-ing-segment"><span class="viz-segment-label">40%</span>
					</ul>
					<ul class="viz-scale viz-scale-regional">
						<li class="viz-scale-segment viz-smallcaps viz-detail viz-reg-segment"><span class="viz-segment-label">-15</span>
						<li class="viz-scale-segment viz-smallcaps viz-detail viz-reg-segment"><span class="viz-segment-label">-5</span>
						<li class="viz-scale-segment viz-smallcaps viz-detail viz-reg-segment"><span class="viz-segment-label">5</span>
						<li class="viz-scale-segment viz-smallcaps viz-detail viz-reg-segment"><span class="viz-segment-label">15</span>
						<li class="viz-scale-segment viz-smallcaps viz-detail viz-reg-segment"><span class="viz-segment-label">25</span>
						<li class="viz-scale-segment viz-smallcaps viz-detail viz-reg-segment"><span class="viz-segment-label">35% and up</span>
					</ul>
				</div>
			</div>
		</section>
		<section class="viz-content-block viz-charts-wrapper">
			<header class="viz-generator-header">
				<h4 class="viz-hed">Top 5 Distinctive Terms, All States</h4>
			</header>
			<p class="viz-copy viz-charts-intro"><span class="viz-leadin viz-intro-leadin">The charts below show</span> each state's top five menu terms. View this page at larger widths to see maps for the most popular ingredient in each state, and nationwide popularity maps for ingredients such as ranch dressing and green bell peppers.</p>		
			<div class="viz-list-wrapper">
				<ul class="viz-states viz-states-col-1"></ul>
				<ul class="viz-states viz-states-col-2"></ul>
			</div>
		</section>
		<footer class="viz-footer">
			<!-- <p class="viz-source"> -->
			<p class="viz-source"><span class="viz-leadin">Source</span> Food Genius <span class="viz-leadin">Methodology</span> Food Genius tracks term appearance on unique menus. So even if "bacon" appears eight times on Waffle House's menu, and there are 20 Waffle House locations in Georgia, Food Genius only increases the count for "bacon" in Georgia by one. The range of Food Genius's coverage spans from Washington D.C., where the company tracks an estimated 85% of restaurants, to Alaska, from which almost all of the data comes from chain restaurants. <span class="viz-leadin">Graphic</span> Gus Wezerek</p>
			<!-- <p class="viz-source"></p> -->
		</footer>
	</div>

	<!-- Templates for States -->
	<script type="text/template" class="viz-state-template">
		<li class="viz-state" data-state="<%= key %>">
			<a class="viz-state-anchor"><h5 class="viz-subhead"><%= values[0].state_fullname %></h5></a>
			<table class="viz-table">
				<thead class="viz-thead">
					<tr class="viz-body-tr">
						<th class="viz-th" scope="col">Term</th>
						<th class="viz-th viz-table-quant-val viz-table-downplay-val" scope="col"><%= key %> (%)</th>
						<th class="viz-th viz-table-quant-val viz-table-downplay-val" scope="col">U.S. (%)</th>
						<th class="viz-th viz-table-quant-val" scope="col">Diff. (%)</th>
					</tr>
				</thead>
				<tbody>
					<% _.each(_.range(0,5), function(i){ %>
						<tr class="viz-body-tr">
							<td class="viz-td"><%= values[i].term %></td>
							<td class="viz-td viz-table-quant-val viz-table-downplay-val"><%= d3.round(values[i].percent_state * 100) %></td>
							<td class="viz-td viz-table-quant-val viz-table-downplay-val"><%= d3.round(values[i].percent_us * 100) %></td>
							<td class="viz-td viz-table-quant-val"><%= d3.round(values[i].diff * 100) %></td>
						</tr>
					<% }); %>
				</tbody>
			</table>
		</li>
	</script>

	<script type="text/javascript">

		window.FC = window.FC || {};
	    window.FC.inlineFunctions = window.FC.inlineFunctions || {};

	    window.FC.inlineFunctions.graphicScript = function() {

			// SETUP VARIABLES
			// =============================================

			var INGDATA, REGIONALDATA, MAPDATA, STATES;

			var jsonURL = "http://www.fastcodesign.com/asset_files/-/2014/04/22/us.json";
			var regionalTSV = "http://www.fastcodesign.com/asset_files/-/2014/04/22/regional_ingredients.tsv";
			var spreadsheetURL = "http://www.fastcodesign.com/asset_files/-/2014/04/22/food_genius.tsv";

			// For template
			var statesTemplate = _.template( $(".viz-state-template").html() );







			// D3
			// =============================================

			var width = 868,
				height = 550;

			var color = d3.scale.quantize();

			var projection = d3.geo.albersUsa()
				.scale(1180)
				.translate([width / 2, height / 2]);

			var path = d3.geo.path()
				.projection(projection);

			var svg = d3.select(".viz-svg-wrap").append("svg")
				.attr("width", width)
				.attr("height", height);

			queue()
				.defer(d3.json, jsonURL)
				.defer(d3.tsv, spreadsheetURL)
				.defer(d3.tsv, regionalTSV)
				.await(ready);



			function ready(error, us, termData, regionalData) {

				var nested_regional = d3.nest()
					.key(function(d) {return d.state; })
					.entries(regionalData);

				var nested_terms = d3.nest()
					.key(function(d) {return d.state; })
					.entries(termData);

				REGIONALDATA = nested_regional;
				INGDATA = nested_terms;
				MAPDATA = us;

				populateStates(INGDATA);

				// Create the state paths
				var states = svg.selectAll("path")
					.data(us.features)
				  .enter().append("path")
					.attr("d", path)
					.attr("class", "viz-state-shape");

				STATES = states;

				// Shade map
				drawIngMap(us, states);

				// Now that the elements exist we can bind handlers
				bindMapHandlers();
			}










			// HANDLERS
			// =============================================


			function bindMapHandlers() {

				// Regional map btns
				$(".viz-regional-btn").on("click", function(){
					var term = $(this).data("term");

					updateLayout($(this));
					drawRegionalMap(MAPDATA, STATES, term);
				});

				// Top terms map btn
				$(".viz-terms-btn").on("click", function(){
					updateLayout($(this));
					drawIngMap(MAPDATA, STATES);
				});

				// State hover functionality
				$(".viz-content-block").on({
					mouseenter: function() {
						var callout = $(".viz-hover-callout");
						var states = $(".viz-state");
						var state = this.id;
						var element = states.filter("[data-state='" + state + "']").first();
						var toInsert = element.clone();

						d3.select(this).moveToFront();

						if (this instanceof SVGElement) {
							this.addClass("viz-state-active");
						} else {
							var partnerState = d3.select("#" + state);
							partnerState.moveToFront();
							partnerState[0][0].addClass("viz-state-active");
						}

						callout.html(toInsert);
					},
					mouseleave: function() {
						var state = this.id;

						if (this instanceof SVGElement) {
							this.removeClass("viz-state-active");
						} else {
							d3.select("#" + state)[0][0].removeClass("viz-state-active");
						}
					}
				}, ".viz-state-shape, .viz-proxy");

			}




			// HELPERS
			// =============================================

			function updateLayout(target) {
				$(".viz-map-hed").hide();
				$(".viz-map-intro").hide();
				$(".viz-scale").hide();
				$(".viz-nav-btn").removeClass("viz-nav-btn-active");
				target.addClass("viz-nav-btn-active");
			}

			function drawRegionalMap(data, states, term) {

				$(".viz-proxy").hide();
				$(".viz-" + term).show();
				$(".viz-scale-regional").fadeIn(200);
				$(".viz-map-overlay").fadeOut(200);

				color.range(['rgb(178,24,43)','rgb(214,96,77)','rgb(244,165,130)','rgb(253,219,199)','rgb(255,255,255)','rgb(224,224,224)'])
					.domain([45, -15]);

				// Merge diff vals from REGIONALDATA into us data object
				if (!data.features[0].properties[term + "_diff"]) {
					for (var i = 0; i < REGIONALDATA.length; i++) {

						var state = REGIONALDATA[i];

						var regionalDataState = state.key;

						//Find the corresponding state inside the GeoJSON
						for (var j = 0; j < data.features.length; j++) {

							var jsonState = data.features[j].properties.abrv;

							if (regionalDataState == jsonState) {

								//Copy the termData value into the JSON
								data.features[j].properties[term + "_diff"] = parseFloat(state.values[0][term + "_diff"]);

								//Stop looking through the JSON
								break;
							}
						}
					}
				}

				states.style("stroke", "rgb(204, 198, 185)")
					.style("fill", function(d) {
						var value = d.properties[term + "_diff"];
						return color(value);
					});
			}

			function drawIngMap(data, states) {
				
				$(".viz-terms").show();
				$(".viz-proxy").show();
				$(".viz-scale-ing").fadeIn(200);
				$(".viz-map-overlay").fadeIn(200);

				color.range(['rgb(254,229,217)','rgb(252,174,145)','rgb(251,106,74)','rgb(203,24,29)'])
					.domain([0.1, 0.5]);

				// Merge diff vals from INGDATA into us data object
				if (!data.features[0].properties.value) {
					for (var i = 0; i < INGDATA.length; i++) {
						var ingArray = [];

						_.each(INGDATA[i].values, function(e, j) {
							if (INGDATA[i].values[j].type === "ingredient" || INGDATA[i].values[j].type === "dish") {
								ingArray.push(INGDATA[i].values[j]);
							}
						});

						var mostDiff = ingArray[0];
						var termDataState = mostDiff.state_fullname;

						//Find the corresponding state inside the GeoJSON
						for (var j = 0; j < data.features.length; j++) {

							var jsonState = data.features[j].properties.name;

							if (termDataState == jsonState) {

								//Copy the termData value into the JSON
								data.features[j].properties.value = mostDiff.diff;
								data.features[j].properties.abrv =  mostDiff.state;
								data.features[j].properties.term = mostDiff.term;

								//Stop looking through the JSON
								break;
							}
						}
					}
				}

				states.style("stroke", "rgb(255, 255, 255)")
					.attr("id", function(d) { return d.properties.abrv; })
					.style("fill", function(d) {
						var value = d.properties.value;
						return color(value);
					});
			}


			function populateStates(data) {
				var myObj = {};
				var toAppendString1 = "";
				var toAppendString2 = "";
				var dataLength = data.length;
				var toPercent = d3.format("%");


				// Create objects that underscore likes
				myObj["states"] = data;
				data = myObj;
				
				// Compile the list
				for (i = 0; i < dataLength; i++) {
					if (i < dataLength/2 ) {
						toAppendString1 += statesTemplate(data.states[i]);
					} else {
						toAppendString2 += statesTemplate(data.states[i]);
					}
				}

				// Append the lists
				$(".viz-states-col-1").html(toAppendString1);
				$(".viz-states-col-2").html(toAppendString2);
			}

			var percentTimesHundo = function(val) {
				val  = val * 100;
				// var formatVal = d3.format(".0");
				return d3.round(val);
			};


			// SVG HELPERS
			// =============================================

			d3.selection.prototype.moveToFront = function() {
				return this.each(function() {
					this.parentNode.appendChild(this);
				});
			};

			SVGElement.prototype.hasClass = function(className) {
				return new RegExp('(\\s|^)' + className + '(\\s|$)').test(this.getAttribute("class"));
			};

			SVGElement.prototype.addClass = function(className) {
				if (!this.hasClass(className)) {
					this.setAttribute("class", this.getAttribute("class") + " " + className);
				}
			};

			SVGElement.prototype.removeClass = function(className) {
				var removedClass = this.getAttribute("class").replace(new RegExp("(\\s|^)" + className + "(\\s|$)", "g"), "$2");
				if (this.hasClass(className)) {
					this.setAttribute("class", removedClass);
				}
			};

		};

		require(['/js/vendor/d3.min.js', 'http://d3js.org/queue.v1.min.js', 'http://d3js.org/topojson.v1.min.js'], function(d3, queue, topojson) {
	      window.d3 = d3;
	      window.queue = queue;
	      window.topojson = topojson;
	      window.FC.inlineFunctions.graphicScript();
	    });

	</script>

</article>